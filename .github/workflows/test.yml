name: test
on: push
jobs:
  golangci:
    name: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: setup
        uses: actions/setup-go@v3
        with:
          go-version: 1.20.x
      - name: build
        run: make build
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: v1.51.1
  test:
    runs-on: ubuntu-latest
    steps:
      - name: setup
        uses: actions/setup-go@v3
        with:
          go-version: 1.20.x
      - name: checkout
        uses: actions/checkout@v3
      - name: test
        run: go test ./...
      - name: scan
        run: make scan | grep "Licensing OK"
  iop:
    runs-on: ubuntu-latest
    env:
      NO_TTY: "1"
    steps:
      - name: checkout
        uses: actions/checkout@v3
      - name: test findy as Bob
        run: |
          cd ./env
          make aath-up-check \
            AGENT_DEFAULT=acapy \
            AGENT_BOB=findy \
            INCLUDE_TAGS='@T001-RFC0160,@T001-RFC0036,@T001-RFC0037'
      - name: test findy as Acme
        run: |
          cd ./env
          make aath-test-check \
            AGENT_DEFAULT=findy \
            AGENT_BOB=acapy \
            INCLUDE_TAGS='@T001-RFC0160,@T001-RFC0036,@T001-RFC0037'
      - name: test AIP2.0 findy as Acme 
        run: |
          cd ./env
          make aath-test-check-aip20 \
            AGENT_DEFAULT=findy \
            AGENT_BOB=acapy-main
      # - name: test AIP2.0 findy as Acme, javascript as Bob
      #   run: |
      #     cd ./env
      #     make aath-test-check-aip20 \
      #       AGENT_DEFAULT=findy \
      #       AGENT_BOB=javascript
      - name: test findy as default
        run: |
          cd ./env
          make aath-test-check \
            AGENT_DEFAULT=findy \
            AGENT_BOB=findy \
            INCLUDE_TAGS='@T001-RFC0160,@T001-RFC0036,@T001-RFC0037'
      - name: Collect docker logs
        if: ${{ failure() }}
        uses: jwalton/gh-docker-logs@v2.0.2
        with:
          dest: "./tests_output/docker-logs"
      - name: archive logs
        if: ${{ failure() }}
        uses: actions/upload-artifact@v3
        with:
          name: iop-logs
          path: tests_output
